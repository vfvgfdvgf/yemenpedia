{% extends 'base.html' %}
{% load static %}

{% block title %}{{ article.title }} - يمنبيديا{% endblock %}

{% block content %}
<article class="article-detail">
    <div class="article-header">
        <div class="container">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'articles:article_list' %}">الرئيسية</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ article.title|truncatechars:30 }}</li>
                </ol>
            </nav>
            
            <h1 class="article-title">{{ article.title }}</h1>
            
            <div class="article-meta">
                <span class="pub-date">
                    <i class="far fa-calendar-alt"></i> {{ article.pub_date|date:"d M Y, H:i" }}
                </span>
                <span class="views-count">
                    <i class="far fa-eye"></i> {{ article.views }} مشاهدة
                </span>
                {% if article.category %}
                <span class="category">
                    <i class="far fa-folder"></i> 
                    <a href="?category={{ article.category.slug }}">{{ article.category.name }}</a>
                </span>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="article-content container">
        {% if article.image %}
        <div class="article-image">
            <img src="{{ article.image.url }}" alt="{{ article.title }}" class="featured-image">
            {% if article.image_caption %}
            <p class="image-caption">{{ article.image_caption }}</p>
            {% endif %}
        </div>
        {% endif %}
        
        <div class="content-text">
            {{ article.content|linebreaks }}
        </div>
        
        <div class="article-actions">
            {% if user.is_authenticated %}
            <button id="bookmark-btn" class="btn-bookmark" data-article-id="{{ article.pk }}">
                {% if is_bookmarked %}
                    <i class="fas fa-bookmark"></i> إزالة من المحفوظات
                {% else %}
                    <i class="far fa-bookmark"></i> حفظ للمراجعة لاحقًا
                {% endif %}
            </button>
            {% else %}
            <p class="auth-required"><a href="{% url 'login' %}?next={{ request.path }}">سجل الدخول</a> لحفظ المقالات</p>
            {% endif %}
            
            <div class="share-buttons">
                <span>شارك المقال:</span>
                <a href="#" class="share-btn facebook"><i class="fab fa-facebook-f"></i></a>
                <a href="#" class="share-btn twitter"><i class="fab fa-twitter"></i></a>
                <a href="#" class="share-btn whatsapp"><i class="fab fa-whatsapp"></i></a>
                <a href="#" class="share-btn linkedin"><i class="fab fa-linkedin-in"></i></a>
            </div>
        </div>
    </div>
</article>

<section class="related-articles">
    <div class="container">
        <h2 class="section-title">مقالات ذات صلة</h2>
        <div class="articles-grid">
            {% for related in related_articles %}
            <div class="related-card">
                {% if related.image %}
                <div class="card-image">
                    <img src="{{ related.image.url }}" alt="{{ related.title }}">
                </div>
                {% endif %}
                <div class="card-content">
                    <h3><a href="{% url 'articles:article_detail' related.pk %}">{{ related.title }}</a></h3>
                    <p class="meta">
                        <span>{{ related.pub_date|date:"d M Y" }}</span>
                        {% if related.category %}
                        <span>•</span>
                        <span>{{ related.category.name }}</span>
                        {% endif %}
                    </p>
                </div>
            </div>
            {% empty %}
            <p class="no-related">لا توجد مقالات ذات صلة حالياً.</p>
            {% endfor %}
        </div>
    </div>
</section>

<section class="comments-section">
    <div class="container">
        <h2 class="section-title">التعليقات <span>({{ comments.count }})</span></h2>
        
        <div class="comments-list">
            {% for comment in comments %}
            <div class="comment">
                <div class="comment-header">
                    <span class="comment-author">{{ comment.name }}</span>
                    <span class="comment-date">{{ comment.created|date:"d M Y H:i" }}</span>
                </div>
                <div class="comment-body">
                    {{ comment.body|linebreaks }}
                </div>
            </div>
            {% empty %}
            <p class="no-comments">لا توجد تعليقات بعد. كن أول من يعلق!</p>
            {% endfor %}
        </div>
        
        <div class="comment-form">
            <h3>أضف تعليقك</h3>
            <form method="post">
                {% csrf_token %}
                <div class="form-group">
                    {{ comment_form.name }}
                </div>
                <div class="form-group">
                    {{ comment_form.email }}
                </div>
                <div class="form-group">
                    {{ comment_form.body }}
                </div>
                <button type="submit" class="btn-submit">إرسال التعليق</button>
            </form>
        </div>
    </div>
</section>

<style>
    /* تنسيقات الصفحة */
    .article-detail {
        margin-top: 30px;
    }
    
    .article-header {
        padding: 40px 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .breadcrumb {
        padding: 0;
        margin-bottom: 20px;
        background: none;
        font-size: 0.9rem;
    }
    
    .breadcrumb-item a {
        color: #007aff;
        text-decoration: none;
    }
    
    .breadcrumb-item.active {
        color: #86868b;
    }
    
    .article-title {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1.3;
        margin-bottom: 20px;
    }
    
    .article-meta {
        display: flex;
        gap: 20px;
        color: #86868b;
        font-size: 0.9rem;
    }
    
    .article-meta i {
        margin-left: 5px;
    }
    
    .article-meta a {
        color: #007aff;
        text-decoration: none;
    }
    
    .article-content {
        padding: 50px 0;
        line-height: 1.8;
    }
    
    .article-image {
        margin-bottom: 40px;
    }
    
    .featured-image {
        width: 100%;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin-bottom: 15px;
    }
    
    .image-caption {
        text-align: center;
        color: #86868b;
        font-size: 0.9rem;
    }
    
    .content-text {
        font-size: 1.1rem;
        line-height: 1.8;
    }
    
    .content-text p {
        margin-bottom: 25px;
    }
    
    .article-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 50px;
        padding-top: 30px;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .btn-bookmark {
        background: #f5f5f7;
        border: none;
        padding: 10px 20px;
        border-radius: 30px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn-bookmark:hover {
        background: #e5e5e9;
    }
    
    .btn-bookmark i {
        font-size: 1.1rem;
    }
    
    .auth-required a {
        color: #007aff;
        text-decoration: none;
    }
    
    .share-buttons {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .share-buttons span {
        font-size: 0.9rem;
        color: #86868b;
    }
    
    .share-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.9rem;
        transition: transform 0.3s;
    }
    
    .share-btn:hover {
        transform: translateY(-3px);
    }
    
    .facebook { background: #3b5998; }
    .twitter { background: #1da1f2; }
    .whatsapp { background: #25d366; }
    .linkedin { background: #0077b5; }
    
    /* مقالات ذات صلة */
    .related-articles {
        padding: 60px 0;
        background: #f5f5f7;
    }
    
    .section-title {
        font-size: 1.8rem;
        font-weight: 600;
        margin-bottom: 40px;
        position: relative;
    }
    
    .section-title::after {
        content: '';
        position: absolute;
        bottom: -15px;
        right: 0;
        width: 60px;
        height: 3px;
        background-color: #007aff;
    }
    
    .section-title span {
        font-size: 1rem;
        color: #86868b;
        font-weight: normal;
    }
    
    .articles-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 30px;
    }
    
    .related-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        transition: all 0.3s;
    }
    
    .related-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    
    .card-image {
        height: 180px;
        overflow: hidden;
    }
    
    .card-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s;
    }
    
    .related-card:hover .card-image img {
        transform: scale(1.05);
    }
    
    .card-content {
        padding: 20px;
    }
    
    .card-content h3 {
        margin: 0 0 10px;
        font-size: 1.1rem;
    }
    
    .card-content h3 a {
        color: #1d1d1f;
        text-decoration: none;
        transition: color 0.3s;
    }
    
    .card-content h3 a:hover {
        color: #007aff;
    }
    
    .meta {
        display: flex;
        gap: 10px;
        color: #86868b;
        font-size: 0.85rem;
    }
    
    .no-related {
        text-align: center;
        color: #86868b;
        grid-column: 1 / -1;
    }
    
    /* قسم التعليقات */
    .comments-section {
        padding: 60px 0;
    }
    
    .comments-list {
        margin-bottom: 50px;
    }
    
    .comment {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .comment-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
    }
    
    .comment-author {
        font-weight: 600;
    }
    
    .comment-date {
        color: #86868b;
        font-size: 0.85rem;
    }
    
    .comment-body {
        line-height: 1.7;
    }
    
    .no-comments {
        text-align: center;
        color: #86868b;
        padding: 30px;
        background: #f5f5f7;
        border-radius: 12px;
    }
    
    /* نموذج التعليق */
    .comment-form {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .comment-form h3 {
        font-size: 1.3rem;
        margin-bottom: 25px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        font-family: 'Tajawal', sans-serif;
    }
    
    .form-group textarea {
        resize: vertical;
        min-height: 150px;
    }
    
    .btn-submit {
        background: #007aff;
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-submit:hover {
        background: #0062cc;
    }
    
    @media (max-width: 768px) {
        .article-title {
            font-size: 1.8rem;
        }
        
        .article-meta {
            flex-direction: column;
            gap: 8px;
        }
        
        .article-actions {
            flex-direction: column;
            gap: 20px;
            align-items: flex-start;
        }
    }
</style>

<script>
    // زر الحفظ
    document.getElementById('bookmark-btn').addEventListener('click', function() {
        const articleId = this.getAttribute('data-article-id');
        const isBookmarked = this.innerHTML.includes('إزالة');
        
        fetch(`/articles/${articleId}/bookmark/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: isBookmarked ? 'remove' : 'add'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'added') {
                this.innerHTML = '<i class="fas fa-bookmark"></i> إزالة من المحفوظات';
            } else {
                this.innerHTML = '<i class="far fa-bookmark"></i> حفظ للمراجعة لاحقًا';
            }
        });
    });
    
    // مشاركة على وسائل التواصل
    document.querySelectorAll('.share-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const url = window.location.href;
            const title = '{{ article.title }}';
            
            if (this.classList.contains('facebook')) {
                window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank');
            } else if (this.classList.contains('twitter')) {
                window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(url)}`, '_blank');
            } else if (this.classList.contains('whatsapp')) {
                window.open(`https://wa.me/?text=${encodeURIComponent(title + ' ' + url)}`, '_blank');
            } else if (this.classList.contains('linkedin')) {
                window.open(`https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}`, '_blank');
            }
        });
    });
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
{% endblock %}